<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<title>Uzbekistan Org Finder</title>
<style>
body { font-family: Arial; background: #f4f6f9; margin:0; padding:20px; }
h1 { text-align:center; }
#chat { max-width:800px; margin:20px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
#messages { max-height:400px; overflow-y:auto; margin-bottom:20px; padding:10px; border:1px solid #ddd; border-radius:8px; background:#fafafa; }
.msg { display:flex; align-items:flex-end; margin-bottom:10px; }
.msg .avatar { font-size:28px; margin:0 8px; }
.msg.user { justify-content:flex-end; }
.msg.user .bubble { background:#007bff; color:#fff; border-bottom-right-radius:4px; }
.msg.bot { justify-content:flex-start; }
.msg.bot .bubble { background:#eaeaea; border-bottom-left-radius:4px; }
.bubble { display:inline-block; padding:10px 14px; border-radius:16px; max-width:70%; word-wrap:break-word; }
#inputArea { display:flex; gap:10px; }
input { flex:1; padding:10px; border-radius:8px; border:1px solid #ddd; }
button { padding:10px 16px; border:none; border-radius:8px; background:#007bff; color:#fff; cursor:pointer; }
button:hover { background:#0056b3; }
</style>
</head>
<body>
<h1>📊 Uzbekistan Organization Finder</h1>
<div id="chat">
  <div id="messages"></div>
  <div id="inputArea">
    <input id="userInput" type="text" placeholder="Savol yozing..." />
    <button onclick="sendMessage()">Yuborish</button>
  </div>
</div>

<script>
let ws;
let currentCitations = [];
let partialBuffer = "";

function initWS() {
  ws = new WebSocket("ws://" + window.location.host + "/ws");

  ws.onopen = () => console.log("WS ulanish ochildi ✅");

  ws.onmessage = (event) => {
    const data = JSON.parse(event.data);

    if (data.type === "org_info_chunk") {
      // Har bir bo‘lakni yig‘ib boramiz
      partialBuffer += data.data.text;
      renderStreaming(partialBuffer);
    } 
    else if (data.type === "org_info_done") {
      // citationsni olish
      currentCitations = data.data.citations || [];
      // Yakuniy matnni linklar bilan chiqarish
      replaceLastBotMessage(renderWithLinks(data.data.text));
      partialBuffer = "";
    } 
    else if (data.type === "error") {
      addMessage("bot", "❌ Xato: " + data.error);
    }
  };
}

function sendMessage() {
  const input = document.getElementById("userInput");
  const msg = input.value.trim();
  if (!msg) return;
  addMessage("user", msg);
  ws.send(msg);
  input.value = "";
}

function addMessage(role, text) {
  const container = document.getElementById("messages");
  const div = document.createElement("div");
  div.className = "msg " + role;

  const avatar = document.createElement("div");
  avatar.className = "avatar";
  avatar.textContent = role === "user" ? "👩" : "✨";

  const bubble = document.createElement("div");
  bubble.className = "bubble";
  bubble.innerHTML = text;

  if (role === "user") {
    div.appendChild(bubble); div.appendChild(avatar);
  } else {
    div.appendChild(avatar); div.appendChild(bubble);
  }

  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// Stream vaqtida oxirgi bot xabarini yangilash
function renderStreaming(text) {
  const container = document.getElementById("messages");
  let last = container.lastElementChild;
  if (!last || !last.classList.contains("bot")) {
    addMessage("bot", text); // yangi bubble ochiladi
  } else {
    last.querySelector(".bubble").innerHTML = text; // mavjud bubble yangilanadi
  }
}

// Yakunda oxirgi xabarni citations bilan almashtirish
function replaceLastBotMessage(text) {
  const container = document.getElementById("messages");
  let last = container.lastElementChild;
  if (last && last.classList.contains("bot")) {
    last.querySelector(".bubble").innerHTML = text;
  }
}

// Citationlarni linkka aylantirish
function renderWithLinks(text) {
  return text.replace(/\[([0-9]+)\]/g, (match, p1) => {
    const idx = parseInt(p1, 10) - 1;
    if (currentCitations[idx]) {
      return `<a href="${currentCitations[idx]}" target="_blank">[${p1}]</a>`;
    }
    return `[${p1}]`;
  });
}

window.onload = initWS;
</script>
</body>
</html>
